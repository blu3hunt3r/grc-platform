// Database schema for GRC Platform
// Architecture Reference: Section 8 - Data Architecture
// PostgreSQL (Supabase) + Prisma ORM
// Migrated from Neon to Supabase on November 17, 2025

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")       // Connection pooling (PgBouncer)
  // directUrl removed - using pooler for migrations (free tier limitation)
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique // Clerk user ID (hybrid: Clerk auth + Supabase DB)
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  role      UserRole @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  companies Company[]

  @@map("users")
}

model Company {
  id          String   @id @default(uuid())
  name        String
  domain      String?
  description String?
  size        CompanySize?
  industry    String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  audits Audit[]

  @@map("companies")
}

model Audit {
  id          String      @id @default(uuid())
  companyId   String
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Audit details
  framework      Framework   @default(SOC2_TYPE2)
  trustCriteria  String?     // JSON array: ["Security", "Availability", "Confidentiality"]
  status         AuditStatus @default(NOT_STARTED)
  scope          String?     // JSON string for system boundaries

  // Timeline
  startDate   DateTime?
  targetDate  DateTime?
  completedAt DateTime?

  // Progress
  progressPercentage Int @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  evidenceItems Evidence[]
  agentExecutions AgentExecution[]
  findings Finding[]

  @@map("audits")
}

model Evidence {
  id          String   @id @default(uuid())
  auditId     String
  audit       Audit    @relation(fields: [auditId], references: [id], onDelete: Cascade)

  // Evidence details
  controlId   String?  // e.g., "CC6.1" (optional for now during migration)
  control     Control? @relation(fields: [controlId], references: [id])
  controlName String   // e.g., "MFA Enforcement"

  type        EvidenceType
  status      EvidenceStatus @default(PENDING)

  // Content
  description String?
  fileUrl     String?  // S3/R2 URL
  screenshotUrl String? // Screenshot evidence
  apiResponse String?  // JSON response from API

  // Analysis (from AI)
  aiAnalysis  String?  // Claude Vision analysis
  validated   Boolean  @default(false)

  // Metadata
  collectedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("evidence")
}

// ============================================================================
// AGENT ARCHITECTURE
// ============================================================================

model AgentExecution {
  id          String   @id @default(uuid())
  auditId     String?
  audit       Audit?   @relation(fields: [auditId], references: [id], onDelete: Cascade)

  // Agent details
  agentType   AgentType
  agentName   String   // e.g., "Discovery Agent", "Access Control Agent"
  phase       AuditStatus // Which phase of audit this belongs to

  // Execution details
  status      ExecutionStatus @default(RUNNING)
  startedAt   DateTime @default(now())
  completedAt DateTime?
  duration    Int?     // milliseconds

  // Context
  input       String?  // JSON input parameters
  output      String?  // JSON output/results
  error       String?  // Error message if failed

  // Relationships
  decisions   AgentDecision[]
  approvals   Approval[]
  tasks       Task[]
  findings    Finding[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("agent_executions")
  @@index([auditId, agentType])
  @@index([status, startedAt])
}

model AgentDecision {
  id            String   @id @default(uuid())
  executionId   String
  execution     AgentExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  // Decision details
  decisionType  String   // e.g., "SCOPE_DETERMINATION", "GAP_IDENTIFIED", "EVIDENCE_SUFFICIENT"
  description   String
  reasoning     String   // AI reasoning chain (CoT)
  confidence    Float    // 0.0 to 1.0

  // Supporting data
  evidence      String?  // JSON supporting evidence
  alternatives  String?  // JSON alternative options considered

  // Human override
  overridden    Boolean  @default(false)
  overrideBy    String?
  overrideReason String?

  createdAt     DateTime @default(now())

  @@map("agent_decisions")
  @@index([executionId])
}

model Approval {
  id            String   @id @default(uuid())
  executionId   String
  execution     AgentExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  // Approval request
  title         String
  description   String
  type          ApprovalType
  priority      Priority @default(MEDIUM)

  // Status
  status        ApprovalStatus @default(PENDING)
  requestedAt   DateTime @default(now())
  respondedAt   DateTime?

  // Response
  approvedBy    String?  // User ID
  decision      Boolean? // true = approved, false = rejected
  comments      String?

  // Context
  metadata      String?  // JSON additional context

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("approvals")
  @@index([status, priority])
  @@index([requestedAt])
}

model Control {
  id            String   @id @default(uuid())

  // Control identification
  framework     Framework
  controlId     String   // e.g., "CC6.1", "A.9.2.1"
  controlName   String
  category      String   // e.g., "Access Control", "Network Security"

  // Description
  description   String
  requirements  String   // What needs to be proven
  testProcedure String   // How to test/verify

  // Evidence requirements
  evidenceTypes String[] // Array of required evidence types
  frequency     CollectionFrequency

  // Relationships
  findings      Finding[]
  evidence      Evidence[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("controls")
  @@unique([framework, controlId])
  @@index([framework])
}

model Finding {
  id            String   @id @default(uuid())
  auditId       String
  audit         Audit    @relation(fields: [auditId], references: [id], onDelete: Cascade)

  controlId     String?
  control       Control? @relation(fields: [controlId], references: [id])

  executionId   String?
  execution     AgentExecution? @relation(fields: [executionId], references: [id])

  // Finding details
  severity      Severity
  status        FindingStatus @default(OPEN)
  title         String
  description   String

  // Gap analysis
  currentState  String   // What exists today
  requiredState String   // What's needed for compliance
  impact        String   // Business impact description

  // Remediation
  recommendation String
  tasks         Task[]

  // Timeline
  identifiedAt  DateTime @default(now())
  dueDate       DateTime?
  resolvedAt    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("findings")
  @@index([auditId, severity, status])
}

model Task {
  id            String   @id @default(uuid())

  findingId     String?
  finding       Finding? @relation(fields: [findingId], references: [id], onDelete: SetNull)

  executionId   String?
  execution     AgentExecution? @relation(fields: [executionId], references: [id], onDelete: SetNull)

  // Task details
  title         String
  description   String
  type          TaskType
  priority      Priority @default(MEDIUM)
  status        TaskStatus @default(TODO)

  // Assignment
  assignedTo    String?  // User ID
  assignedBy    String   // Agent or User ID
  assignedAt    DateTime?

  // Timeline
  dueDate       DateTime?
  completedAt   DateTime?

  // Metadata
  metadata      String?  // JSON additional context

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("tasks")
  @@index([status, priority])
  @@index([assignedTo])
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  USER
  ADMIN
  AUDITOR
}

enum CompanySize {
  STARTUP       // 1-50
  SMALL         // 51-200
  MEDIUM        // 201-1000
  LARGE         // 1001+
}

enum Framework {
  SOC2_TYPE1
  SOC2_TYPE2
  ISO27001
  HIPAA
  PCI_DSS
}

enum AuditStatus {
  NOT_STARTED
  DISCOVERY
  GAP_ASSESSMENT
  IMPLEMENTATION
  EVIDENCE_COLLECTION
  AUDIT_PREP
  IN_AUDIT
  COMPLETED
  FAILED
}

enum EvidenceType {
  SCREENSHOT
  DOCUMENT
  API_RESPONSE
  LOG_FILE
  CONFIGURATION
  MANUAL_UPLOAD
}

enum EvidenceStatus {
  PENDING
  COLLECTED
  VALIDATED
  REJECTED
  EXPIRED
}

enum AgentType {
  ORCHESTRATOR
  DISCOVERY
  FRAMEWORK_EXPERT
  ACCESS_CONTROL
  INFRASTRUCTURE_SECURITY
  CHANGE_MANAGEMENT
  VENDOR_RISK
  HR_COMPLIANCE
  POLICY_GENERATION
  CODE_SCANNER
  INFRASTRUCTURE_SCANNER
  COMPLIANCE_COPILOT
  QUESTIONNAIRE_AUTOMATION
  EVIDENCE_MANAGEMENT
  AUDIT_COORDINATOR
  INCIDENT_RESPONSE
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  AWAITING_APPROVAL
}

enum ApprovalType {
  SCOPE_APPROVAL          // Approve system boundary
  GAP_REMEDIATION         // Approve remediation plan
  POLICY_APPROVAL         // Approve generated policy
  VENDOR_APPROVAL         // Approve vendor risk assessment
  EVIDENCE_APPROVAL       // Approve collected evidence
  CONTROL_IMPLEMENTATION  // Approve control implementation
  AUDIT_READINESS         // Approve readiness to proceed
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum CollectionFrequency {
  ONCE           // One-time collection
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  CONTINUOUS     // Real-time monitoring
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FindingStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  ACCEPTED_RISK
  FALSE_POSITIVE
}

enum TaskType {
  REMEDIATION        // Fix a gap
  POLICY_CREATION    // Write a policy
  CONFIGURATION      // Configure a system
  DOCUMENTATION      // Document a process
  VENDOR_ASSESSMENT  // Assess a vendor
  EVIDENCE_COLLECTION // Collect evidence
  REVIEW             // Human review needed
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  COMPLETED
  CANCELLED
}
